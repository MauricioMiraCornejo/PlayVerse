{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro - PlayVerse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <link rel="stylesheet" href="{% static 'css/registro.css' %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .mensaje-validacion {
      font-size: 0.9rem;
      margin-top: 0.3rem;
      color: #ff6b6b;
    }
    .mensaje-validacion.ok {
      color: #00ffe7;
    }
    .oculto {
      display: none;
    }
    .cerrar-sesion {
      background-color: transparent;
      border: none;
      color: #fff;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: 1rem;
    }
    .errorlist {
      color: #ff6b6b;
      font-size: 0.9rem;
      margin-top: 0.3rem;
      list-style-type: none;
      padding-left: 0;
    }
    .alert-success {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <h1>PlayVerse</h1>
      <nav class="navbar">
        <div class="logo"></div>
        <ul class="nav-links">          
          <li><a href="{% url 'inicio' %}">Inicio</a></li>
          <li><a href="{% url 'login' %}">Iniciar Sesión</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="form-container">
      <h2>Registro de Usuario</h2>
      
      <!-- Mostrar mensajes de Django -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}

      <form id="registroForm" class="formulario" method="POST" action="{% url 'registro' %}">
        {% csrf_token %}
        
        <!-- Debug: Mostrar todos los errores del formulario -->
        {% if form.errors %}
          <div class="errorlist">
            <strong>Por favor corrige los siguientes errores:</strong>
            {% for field in form %}
              {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
              {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </div>
        {% endif %}
        
        <!-- Campo nombre completo -->
        <label for="id_first_name">Nombre completo:</label>
        <input type="text" name="first_name" id="id_first_name" value="{{ form.first_name.value|default:'' }}" required>
        {% if form.first_name.errors %}
        <div class="errorlist">{{ form.first_name.errors }}</div>
        {% endif %}

        <!-- Campo nombre de usuario -->
        <label for="id_username">Nombre de usuario:</label>
        <input type="text" name="username" id="id_username" value="{{ form.username.value|default:'' }}" required>
        {% if form.username.errors %}
        <div class="errorlist">{{ form.username.errors }}</div>
        {% endif %}

        <!-- Campo correo electrónico -->
        <label for="id_email">Correo electrónico:</label>
        <input type="email" name="email" id="id_email" value="{{ form.email.value|default:'' }}" required>
        <div id="emailMsg" class="mensaje-validacion"></div>
        {% if form.email.errors %}
        <div class="errorlist">{{ form.email.errors }}</div>
        {% endif %}

        <!-- Campo fecha de nacimiento -->
        <label for="id_fecha_nacimiento">Fecha de nacimiento:</label>
        <input type="date" name="fecha_nacimiento" id="id_fecha_nacimiento" value="{{ form.fecha_nacimiento.value|default:'' }}" required>
        <div id="edadMsg" class="mensaje-validacion"></div>
        {% if form.fecha_nacimiento.errors %}
        <div class="errorlist">{{ form.fecha_nacimiento.errors }}</div>
        {% endif %}

        <!-- Campo contraseña -->
        <label for="id_password1">Contraseña:</label>
        <input type="password" name="password1" id="id_password1" required>
        <div id="passMsg" class="mensaje-validacion"></div>
        {% if form.password1.errors %}
        <div class="errorlist">{{ form.password1.errors }}</div>
        {% endif %}

        <!-- Campo confirmar contraseña -->
        <label for="id_password2">Repetir contraseña:</label>
        <input type="password" name="password2" id="id_password2" required>
        <div id="confirmMsg" class="mensaje-validacion"></div>
        {% if form.password2.errors %}
        <div class="errorlist">{{ form.password2.errors }}</div>
        {% endif %}

        <!-- Campo dirección -->
        <label for="id_direccion">Dirección de despacho (opcional):</label>
        <input type="text" name="direccion" id="id_direccion" value="{{ form.direccion.value|default:'' }}">

        <!-- Campo teléfono -->
        <label for="id_telefono">Teléfono (opcional):</label>
        <input type="text" name="telefono" id="id_telefono" value="{{ form.telefono.value|default:'' }}">

        <div style="height: 20px;"></div>

        <div class="botones">
          <button type="submit" class="btn-animado">Enviar</button>
          <button type="reset" class="btn-animado">Limpiar</button>
        </div>
      </form>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 PlayVerse</p>
  </footer>

  <!-- Script de validación en el cliente -->
  <script>
    // Referencias a los campos
    const emailInput = document.getElementById('id_email');
    const passwordInput = document.getElementById('id_password1');
    const confirmInput = document.getElementById('id_password2');
    const fechaInput = document.getElementById('id_fecha_nacimiento');

    const emailMsg = document.getElementById('emailMsg');
    const passMsg = document.getElementById('passMsg');
    const confirmMsg = document.getElementById('confirmMsg');
    const edadMsg = document.getElementById('edadMsg');

    const emailRegex = /^[^@]+@[^@]+\.[a-zA-Z]{2,}$/;
    const passwordRegex = /^(?=.*[A-Z])(?=.*\d).{6,18}$/;

    // Validación en tiempo real
    if (emailInput) {
      emailInput.addEventListener('input', () => {
        if (emailRegex.test(emailInput.value)) {
          emailMsg.textContent = "Correo válido ✔";
          emailMsg.classList.add("ok");
          emailMsg.classList.remove("error");
        } else {
          emailMsg.textContent = "Correo inválido";
          emailMsg.classList.remove("ok");
          emailMsg.classList.add("error");
        }
      });
    }

    if (passwordInput) {
      passwordInput.addEventListener('input', () => {
        if (passwordRegex.test(passwordInput.value)) {
          passMsg.textContent = "Contraseña segura ✔";
          passMsg.classList.add("ok");
          passMsg.classList.remove("error");
        } else {
          passMsg.textContent = "Debe tener entre 6 y 18 caracteres, una mayúscula y un número.";
          passMsg.classList.remove("ok");
          passMsg.classList.add("error");
        }
      });
    }

    if (confirmInput && passwordInput) {
      confirmInput.addEventListener('input', () => {
        if (confirmInput.value === passwordInput.value) {
          confirmMsg.textContent = "Las contraseñas coinciden ✔";
          confirmMsg.classList.add("ok");
          confirmMsg.classList.remove("error");
        } else {
          confirmMsg.textContent = "Las contraseñas no coinciden";
          confirmMsg.classList.remove("ok");
          confirmMsg.classList.add("error");
        }
      });
    }

    if (fechaInput) {
      fechaInput.addEventListener('input', () => {
        const edad = calcularEdad(fechaInput.value);
        if (edad >= 13) {
          edadMsg.textContent = "Edad válida ✔";
          edadMsg.classList.add("ok");
          edadMsg.classList.remove("error");
        } else {
          edadMsg.textContent = "Debes tener al menos 13 años";
          edadMsg.classList.remove("ok");
          edadMsg.classList.add("error");
        }
      });
    }

    // Función para calcular edad
    function calcularEdad(fecha) {
      if (!fecha) return 0;
      const hoy = new Date();
      const nacimiento = new Date(fecha);
      let edad = hoy.getFullYear() - nacimiento.getFullYear();
      const m = hoy.getMonth() - nacimiento.getMonth();
      if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
      }
      return edad;
    }
  </script>
</body>
</html>